<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Daily Artefact</title>
  <!-- Umami Analytics -->
  <script defer src="https://cloud.umami.is/script.js" data-website-id="d0bd9eaa-b94c-4925-9d4a-a62bfc397619"></script>
  <!-- Favicons -->
  <link rel="icon" href="/favicon.ico" sizes="48x48">
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/favicon-512x512.png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;400;600&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #0a0a0a;
      color: #ffffff;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
    }

    #canvas-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }

    /* 加载状态 */
    #loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #0a0a0a;
      z-index: 100;
      transition: opacity 0.8s ease;
    }

    #loader.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .loader-cube {
      width: 40px;
      height: 40px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      animation: spin 2s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotateX(0deg) rotateY(0deg); }
      100% { transform: rotateX(360deg) rotateY(360deg); }
    }

    .loader-text {
      margin-top: 20px;
      font-size: 12px;
      font-weight: 200;
      letter-spacing: 4px;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.5);
    }

    /* 左侧时间面板 */
    #left-panel {
      position: fixed;
      left: 40px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 10;
      pointer-events: none;
      opacity: 0;
      transition: opacity 1s ease;
    }

    #left-panel.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .date-nav {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 12px;
    }

    .nav-buttons {
      display: flex;
      gap: 8px;
    }

    .nav-btn {
      width: 36px;
      height: 36px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.05);
      color: rgba(255, 255, 255, 0.8);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .nav-btn:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.4);
    }

    .nav-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .year {
      font-size: 14px;
      font-weight: 200;
      letter-spacing: 4px;
      color: rgba(255, 255, 255, 0.5);
      margin-bottom: 4px;
    }

    .date {
      font-size: 80px;
      font-weight: 200;
      letter-spacing: -3px;
      line-height: 1;
      color: rgba(255, 255, 255, 0.95);
    }

    .month {
      font-size: 16px;
      font-weight: 400;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.6);
      margin-top: 8px;
    }

    .coordinates {
      font-size: 11px;
      font-weight: 400;
      letter-spacing: 2px;
      color: rgba(255, 255, 255, 0.35);
      margin-top: 20px;
    }

    .location {
      font-size: 12px;
      font-weight: 400;
      color: rgba(255, 255, 255, 0.45);
      margin-top: 4px;
    }

    /* 右侧描述面板 */
    #right-panel {
      position: fixed;
      right: 40px;
      top: 50%;
      transform: translateY(-50%);
      max-width: 360px;
      z-index: 10;
      pointer-events: none;
      opacity: 0;
      transition: opacity 1s ease;
      text-align: left;
    }

    #right-panel.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .title {
      font-size: 24px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.95);
      margin-bottom: 16px;
      line-height: 1.3;
    }

    .description {
      font-size: 15px;
      font-weight: 400;
      line-height: 1.8;
      color: rgba(255, 255, 255, 0.75);
    }

    .description .cursor {
      display: inline-block;
      width: 2px;
      height: 1.2em;
      background: rgba(255, 255, 255, 0.8);
      margin-left: 2px;
      animation: blink 1s infinite;
      vertical-align: text-bottom;
    }

    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }

    .source-event {
      font-size: 11px;
      font-weight: 400;
      letter-spacing: 1px;
      color: rgba(255, 255, 255, 0.35);
      margin-top: 20px;
      text-transform: uppercase;
    }

    /* 移动端布局 */
    @media (max-width: 900px) {
      #left-panel {
        left: 20px;
        top: auto;
        bottom: 120px;
        transform: none;
      }

      #right-panel {
        right: 20px;
        left: 20px;
        top: auto;
        bottom: 20px;
        transform: none;
        max-width: none;
        text-align: left;
      }

      .date {
        font-size: 56px;
      }

      .title {
        font-size: 18px;
      }

      .description {
        font-size: 14px;
        line-height: 1.6;
      }
    }

    @media (max-width: 600px) {
      #left-panel {
        left: 16px;
        bottom: 160px;
      }

      #right-panel {
        right: 16px;
        left: 16px;
        bottom: 16px;
      }

      .date {
        font-size: 48px;
      }

      .nav-btn {
        width: 32px;
        height: 32px;
        font-size: 12px;
      }
    }

    /* 错误状态 */
    #error {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 50;
      display: none;
    }

    #error.visible {
      display: block;
    }

    #error h2 {
      font-size: 18px;
      font-weight: 400;
      margin-bottom: 12px;
    }

    #error p {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.5);
    }

    /* 过渡动画 */
    .fade-out {
      opacity: 0 !important;
      transition: opacity 0.3s ease;
    }

    /* Powered by Tripo */
    .powered-by {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 20;
      font-size: 12px;
      font-weight: 400;
      color: rgba(255, 255, 255, 0.4);
      text-decoration: none;
      transition: color 0.3s ease;
      letter-spacing: 0.5px;
    }

    .powered-by:hover {
      color: rgba(255, 255, 255, 0.8);
    }

    .powered-by span {
      color: rgba(255, 255, 255, 0.6);
      font-weight: 600;
    }

    .powered-by:hover span {
      color: #fff;
    }

    @media (max-width: 600px) {
      .powered-by {
        top: 12px;
        right: 12px;
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <!-- Powered by Tripo -->
  <a href="https://studio.tripo3d.ai/home" target="_blank" rel="noopener" class="powered-by" data-umami-event="click-tripo">
    Powered by <span>Tripo</span>
  </a>

  <!-- 加载状态 -->
  <div id="loader">
    <div class="loader-cube"></div>
    <div class="loader-text">Loading</div>
  </div>

  <!-- 3D 画布 -->
  <div id="canvas-container"></div>

  <!-- 左侧时间面板 -->
  <div id="left-panel">
    <div class="date-nav">
      <div class="nav-buttons">
        <button class="nav-btn" id="prev-btn" disabled>←</button>
        <button class="nav-btn" id="next-btn" disabled>→</button>
      </div>
      <div class="year" id="year"></div>
      <div class="date" id="date"></div>
      <div class="month" id="month"></div>
      <div class="coordinates" id="coordinates"></div>
      <div class="location" id="location"></div>
    </div>
  </div>

  <!-- 右侧描述面板 -->
  <div id="right-panel">
    <div class="title" id="title"></div>
    <div class="description" id="description"><span class="cursor"></span></div>
    <div class="source-event" id="source-event"></div>
  </div>

  <!-- 错误状态 -->
  <div id="error">
    <h2 id="error-title">暂无内容</h2>
    <p id="error-desc">今日的物件正在生成中...</p>
  </div>

  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.170.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.170.0/examples/jsm/"
    }
  }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    // 国际化 - 支持多语言
    const i18n = {
      zh: {
        months: ['一月', '二月', '三月', '四月', '五月', '六月',
                 '七月', '八月', '九月', '十月', '十一月', '十二月'],
        loading: '加载中',
        noContent: '暂无内容',
        generating: '今日的物件正在生成中...',
        source: '来源'
      },
      en: {
        months: ['January', 'February', 'March', 'April', 'May', 'June',
                 'July', 'August', 'September', 'October', 'November', 'December'],
        loading: 'Loading',
        noContent: 'No Content',
        generating: 'Today\'s artefact is being generated...',
        source: 'Source'
      },
      ja: {
        months: ['1月', '2月', '3月', '4月', '5月', '6月',
                 '7月', '8月', '9月', '10月', '11月', '12月'],
        loading: '読み込み中',
        noContent: 'コンテンツなし',
        generating: '本日のアーティファクトを生成中...',
        source: 'ソース'
      },
      ko: {
        months: ['1월', '2월', '3월', '4월', '5월', '6월',
                 '7월', '8월', '9월', '10월', '11월', '12월'],
        loading: '로딩 중',
        noContent: '콘텐츠 없음',
        generating: '오늘의 아티팩트 생성 중...',
        source: '출처'
      },
      es: {
        months: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
        loading: 'Cargando',
        noContent: 'Sin contenido',
        generating: 'El artefacto de hoy se está generando...',
        source: 'Fuente'
      },
      ru: {
        months: ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'],
        loading: 'Загрузка',
        noContent: 'Нет контента',
        generating: 'Артефакт дня создается...',
        source: 'Источник'
      },
      pt: {
        months: ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'],
        loading: 'Carregando',
        noContent: 'Sem conteúdo',
        generating: 'O artefato de hoje está sendo gerado...',
        source: 'Fonte'
      }
    };

    // 支持的语言列表
    const SUPPORTED_LANGS = ['zh', 'en', 'ja', 'ko', 'es', 'ru', 'pt'];

    // 检测语言
    function detectLanguage() {
      const lang = navigator.language || navigator.userLanguage;
      const shortLang = lang.split('-')[0].toLowerCase();
      // 中文特殊处理
      if (lang.startsWith('zh')) return 'zh';
      // 检查是否是支持的语言
      if (SUPPORTED_LANGS.includes(shortLang)) return shortLang;
      // 默认英语
      return 'en';
    }

    let currentLang = detectLanguage();
    let t = i18n[currentLang];

    // 更新静态文本
    document.querySelector('.loader-text').textContent = t.loading;
    document.getElementById('error-title').textContent = t.noContent;
    document.getElementById('error-desc').textContent = t.generating;

    // DOM 元素
    const container = document.getElementById('canvas-container');
    const loader = document.getElementById('loader');
    const leftPanel = document.getElementById('left-panel');
    const rightPanel = document.getElementById('right-panel');
    const errorEl = document.getElementById('error');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');

    // R2 公开域名
    const R2_BASE_URL = 'https://today-3d-models.pdjjq.org';

    // 获取模型完整 URL
    function getModelUrl(key) {
      if (key.startsWith('http')) {
        return key;
      }
      return `${R2_BASE_URL}/${key}`;
    }

    // 当前数据
    let currentData = null;
    let isLoading = false;

    // Three.js 场景设置
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0a0a0a);

    const camera = new THREE.PerspectiveCamera(
      45,
      window.innerWidth / window.innerHeight,
      0.1,
      1000
    );
    camera.position.set(0, 0, 5);

    const renderer = new THREE.WebGLRenderer({
      antialias: true,
      alpha: true,
    });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.2;
    container.appendChild(renderer.domElement);

    // 控制器
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.enablePan = false;
    controls.minDistance = 2;
    controls.maxDistance = 10;
    controls.autoRotate = true;
    controls.autoRotateSpeed = 0.5;

    // 用户交互时暂停自动旋转
    let userInteracting = false;
    controls.addEventListener('start', () => {
      userInteracting = true;
      controls.autoRotate = false;
    });
    controls.addEventListener('end', () => {
      userInteracting = false;
      setTimeout(() => {
        if (!userInteracting) {
          controls.autoRotate = true;
        }
      }, 5000);
    });

    // 灯光 - 三点布光 + 顶部聚光灯
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.2);
    scene.add(ambientLight);

    // 主光 (Key Light) - 右前方 45°，暖色
    const keyLight = new THREE.DirectionalLight(0xffeedd, 1);
    keyLight.position.set(4, 4, 4);
    scene.add(keyLight);

    // 补光 (Fill Light) - 左前方，冷色
    const fillLight = new THREE.DirectionalLight(0x8888ff, 1);
    fillLight.position.set(-4, 2, 3);
    scene.add(fillLight);

    // 轮廓光 (Rim Light) - 后方，勾勒边缘
    const rimLight = new THREE.DirectionalLight(0xffffff, 1);
    rimLight.position.set(0, 3, -5);
    scene.add(rimLight);

    // 博物馆顶部聚光灯
    const spotLight = new THREE.SpotLight(0xfff5e6, 3);
    spotLight.position.set(0, 7, 0);
    spotLight.target.position.set(0, 0, 0);
    spotLight.angle = (28 * Math.PI) / 180;  // 28°
    spotLight.penumbra = 0.5;
    spotLight.decay = 0;
    spotLight.distance = 0;
    scene.add(spotLight);
    scene.add(spotLight.target);

    // 模型加载器
    const gltfLoader = new GLTFLoader();
    let currentModel = null;

    // 加载模型
    function loadModel(url) {
      return new Promise((resolve, reject) => {
        gltfLoader.load(
          url,
          (gltf) => {
            const model = gltf.scene;
            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            model.position.sub(center);
            const maxDim = Math.max(size.x, size.y, size.z);
            const scale = 2 / maxDim;
            model.scale.setScalar(scale);

            // 调整材质粗糙度和金属度
            model.traverse((child) => {
              if (child.isMesh && child.material) {
                const materials = Array.isArray(child.material) ? child.material : [child.material];
                materials.forEach((mat) => {
                  if (mat.isMeshStandardMaterial || mat.isMeshPhysicalMaterial) {
                    mat.roughness = 0;
                    mat.metalness = 0;
                    mat.needsUpdate = true;
                  }
                });
              }
            });

            resolve(model);
          },
          undefined,
          reject
        );
      });
    }

    // 打字机效果
    function typeWriter(element, text, speed = 40) {
      return new Promise((resolve) => {
        element.innerHTML = '';
        let i = 0;
        const cursor = document.createElement('span');
        cursor.className = 'cursor';

        function type() {
          if (i < text.length) {
            element.innerHTML = text.substring(0, i + 1);
            element.appendChild(cursor);
            i++;
            setTimeout(type, speed);
          } else {
            setTimeout(() => {
              cursor.remove();
              resolve();
            }, 2000);
          }
        }
        type();
      });
    }

    // 格式化日期
    function formatDateParts(dateStr) {
      const date = new Date(dateStr);
      return {
        year: date.getFullYear(),
        day: String(date.getDate()).padStart(2, '0'),
        month: t.months[date.getMonth()]
      };
    }

    // 格式化坐标
    function formatCoordinates(lat, lng) {
      const latDir = lat >= 0 ? 'N' : 'S';
      const lngDir = lng >= 0 ? 'E' : 'W';
      return `${Math.abs(lat).toFixed(2)}° ${latDir}, ${Math.abs(lng).toFixed(2)}° ${lngDir}`;
    }

    // 从 URL 解析日期
    function getDateFromUrl() {
      const path = window.location.pathname;
      const match = path.match(/^\/(\d{4}-\d{2}-\d{2})$/);
      return match ? match[1] : null;
    }

    // 更新 URL
    function updateUrl(date) {
      const newUrl = `/${date}`;
      if (window.location.pathname !== newUrl) {
        history.pushState({ date }, '', newUrl);
      }
      // 更新页面标题
      document.title = `${date} - The Daily Artefact`;
    }

    // 获取数据
    async function fetchData(url) {
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error('No data available');
      }
      return response.json();
    }

    // 更新导航按钮
    function updateNavButtons(data) {
      prevBtn.disabled = !data.has_prev;
      nextBtn.disabled = !data.has_next;
    }

    // 获取翻译后的内容
    function getLocalizedContent(data) {
      // 中文是原始语言，直接返回原始数据
      if (currentLang === 'zh') {
        return {
          title: data.title,
          description: data.description,
          location_name: data.location_name,
          source_event: data.source_event,
        };
      }

      // 尝试从 translations 获取翻译
      if (data.translations) {
        try {
          const translations = typeof data.translations === 'string'
            ? JSON.parse(data.translations)
            : data.translations;
          if (translations[currentLang]) {
            return translations[currentLang];
          }
        } catch (e) {
          console.error('Failed to parse translations:', e);
        }
      }

      // 如果没有翻译，回退到原始内容
      return {
        title: data.title,
        description: data.description,
        location_name: data.location_name,
        source_event: data.source_event,
      };
    }

    // 显示数据
    async function displayData(data, animate = true) {
      currentData = data;

      // 更新 URL
      updateUrl(data.date);

      // 加载模型
      const modelUrl = getModelUrl(data.model_url);
      const model = await loadModel(modelUrl);

      // 移除旧模型
      if (currentModel) {
        scene.remove(currentModel);
      }

      // 添加新模型
      currentModel = model;
      scene.add(model);

      // 隐藏加载状态
      loader.classList.add('hidden');

      // 获取本地化内容
      const localizedContent = getLocalizedContent(data);

      // 更新左侧面板
      const dateParts = formatDateParts(data.date);
      document.getElementById('year').textContent = dateParts.year;
      document.getElementById('date').textContent = dateParts.day;
      document.getElementById('month').textContent = dateParts.month;
      document.getElementById('coordinates').textContent = formatCoordinates(data.latitude, data.longitude);
      document.getElementById('location').textContent = localizedContent.location_name;

      // 更新右侧面板
      document.getElementById('title').textContent = localizedContent.title;
      document.getElementById('source-event').textContent = localizedContent.source_event;

      // 更新导航按钮
      updateNavButtons(data);

      // 显示面板
      leftPanel.classList.remove('fade-out');
      leftPanel.classList.add('visible');
      rightPanel.classList.remove('fade-out');
      rightPanel.classList.add('visible');

      // 打字机效果
      if (animate) {
        await typeWriter(document.getElementById('description'), localizedContent.description);
      } else {
        document.getElementById('description').textContent = localizedContent.description;
      }
    }

    // 切换日期
    async function navigate(direction) {
      if (isLoading || !currentData) return;

      isLoading = true;
      prevBtn.disabled = true;
      nextBtn.disabled = true;

      // 淡出当前内容
      leftPanel.classList.add('fade-out');
      rightPanel.classList.add('fade-out');

      try {
        const url = `/api/date/${currentData.date}/${direction}`;
        const data = await fetchData(url);

        // 短暂延迟让淡出动画完成
        await new Promise(r => setTimeout(r, 300));

        await displayData(data, false);
      } catch (error) {
        console.error('Navigation error:', error);
        // 恢复按钮状态
        updateNavButtons(currentData);
        leftPanel.classList.remove('fade-out');
        rightPanel.classList.remove('fade-out');
      } finally {
        isLoading = false;
      }
    }

    // 加载指定日期
    async function loadDate(date) {
      if (isLoading) return;

      isLoading = true;
      loader.classList.remove('hidden');

      try {
        const url = date ? `/api/date/${date}` : '/api/today';
        const data = await fetchData(url);
        await displayData(data);
      } catch (error) {
        console.error('Load error:', error);
        loader.classList.add('hidden');
        errorEl.classList.add('visible');
      } finally {
        isLoading = false;
      }
    }

    // 绑定导航事件
    prevBtn.addEventListener('click', () => navigate('prev'));
    nextBtn.addEventListener('click', () => navigate('next'));

    // 键盘导航
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft' && !prevBtn.disabled) {
        navigate('prev');
      } else if (e.key === 'ArrowRight' && !nextBtn.disabled) {
        navigate('next');
      }
    });

    // 浏览器前进/后退
    window.addEventListener('popstate', (e) => {
      const date = e.state?.date || getDateFromUrl();
      if (date && date !== currentData?.date) {
        loadDate(date);
      }
    });

    // 主函数
    async function init() {
      const urlDate = getDateFromUrl();
      await loadDate(urlDate);
    }

    // 动画循环
    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }

    // 窗口大小调整
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // 启动
    animate();
    init();
  </script>
</body>
</html>
